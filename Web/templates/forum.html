{% extends "base.html" %}

{% block title %}{{ lang.home }} - Smart Tourism{% endblock %}

{% block content %}

<div class="container mt-4">
    <div id="page-data" data-user-id="{{ session.get('user_id', 0) }}"></div>
    <h3 class="fw-bold mb-4">{{lang.your_feed}}</h3>

    <form id="searchForm" class="input-group mb-4" onsubmit="handleSearch(event)">
        <input type="text" id="searchInput" class="form-control" 
               placeholder="{{lang.search}}..." 
               value="{{ request.args.get('search', '') }}">
        <button class="btn btn-primary btn-search" type="submit">{{lang.search}}</button>
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
            <i class="fas fa-times"></i>
        </button>
    </form>

    <div id="feedContainer"></div>

    <p id="endMessage" class="text-center text-muted mt-4" style="display:none">
        {{lang.end_view}}.
    </p>

    <div id="loading" class="text-center mt-4 text-muted" style="display:none">
        {{lang.loading_posts}}...
    </div>
</div>

<script>
let page = 1;         
let loading = false; 
let done = false;
const CURRENT_USER_ID = parseInt(document.getElementById("page-data").dataset.userId);  

const MAX_DOM_POSTS = 40; // ‚úÖ Gi·ªØ t·ªëi ƒëa 40 b√†i tr√™n m√†n h√¨nh
let currentSearchTerm = "";

async function loadFeed() {
    if (loading || done) return;

    loading = true;
    document.getElementById("loading").style.display = "block";

    // ‚úÖ FIX: Th√™m tham s·ªë search v√†o URL
    const searchParam = currentSearchTerm ? `&search=${encodeURIComponent(currentSearchTerm)}` : '';
    const url = `/api/feed?page=${page}${searchParam}`;

    const res = await fetch(url);
    const posts = await res.json();

    document.getElementById("loading").style.display = "none";
    loading = false;

    // ‚úÖ H·∫æT B√ÄI
    if (posts.length === 0) {
        done = true;
        document.getElementById("endMessage").style.display = "block";
        return;
    }

    const feedContainer = document.getElementById("feedContainer");

    posts.forEach(post => {
        const rating = post.rating || 5;

        let stars = "";
        for (let i = 1; i <= 5; i++) {
            stars += i <= rating 
                ? `<i class="fas fa-star text-warning"></i>` 
                : `<i class="far fa-star text-muted"></i>`;
        }

        feedContainer.innerHTML += `
            <div class="card mb-4 shadow-sm feed-item">

                <!-- ‚úÖ HEADER -->
                <div class="card-header border-0 d-flex align-items-center gap-2 mt-3">
                    <img src="/static/${post.avatar || '/static/images/default-avatar.jpg'}" 
                         class="rounded-circle"
                         width="60" height="60"
                         onerror="this.src='/static/images/default-avatar.jpg'">

                    <div>
                        <div class="fw-bold">@${post.username}</div>
                        <div class="small text-muted">${post.posted_at}</div>
                    </div>
                </div>

                <!-- ‚úÖ BODY -->
                <div class="card-body pt-2">
                    <h6 class="fw-bold mb-1">${post.food_name}</h6>

                    <!-- ‚≠ê RATING -->
                    <div class="mb-2">${stars}</div>

                    <p class="mb-3">${post.description}</p>

                    ${
                        post.image_filename 
                        ? `<img src="/static/${post.image_filename}" class="img-fluid rounded mb-3">` 
                        : ""
                    }

                    <div class="d-flex justify-content-around border-top pt-2 text-muted">
                        <div class="like-btn d-flex align-items-center gap-1"
                            style="cursor:pointer"
                            onclick="toggleLike(${post.id})">

                            <i id="like-icon-${post.id}" 
                            class="${post.is_liked ? "fas fa-thumbs-up text-primary" : "far fa-thumbs-up"}">
                            </i>

                            <span id="like-count-${post.id}">
                                ${post.like_count}
                            </span>
                            Like
                        </div>

                        <div class="comment-btn d-flex align-items-center gap-1"
                            style="cursor:pointer"
                            onclick="toggleComments(${post.id})">

                            üí¨ <span id="comment-count-${post.id}">
                                ${post.comment_count}
                            </span> {{lang.comment}}
                        </div>
                    </div>

                    <div id="comment-section-${post.id}" class="px-3 pt-3" style="display:none">

                        ${CURRENT_USER_ID > 0 ? `
                        <form onsubmit="addComment(event, ${post.id})" class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm"
                                placeholder="{{lang.comment}}..." required>
                            <button class="btn btn-sm btn-primary flex-shrink-0">G·ª≠i</button>
                        </form>
                        ` : `
                            <p class="text-center text-muted small">
                                <a href="/login">ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</a>
                            </p>
                        `}

                        <div id="comment-list-${post.id}" class="mt-3">
                            </div>

                    </div>

                </div>
            </div>
`; // Th·∫ª ƒë√≥ng c·ªßa card-body v√† feed-item
    });

    // ‚úÖ T·ª∞ ƒê·ªòNG X√ìA B√ÄI C≈® N·∫æU QU√Å 40 B√ÄI
    const items = document.querySelectorAll(".feed-item");
    if (items.length > MAX_DOM_POSTS) {
        const excess = items.length - MAX_DOM_POSTS;
        for (let i = 0; i < excess; i++) {
            items[i].remove(); 
        }
    }

    page++;       
    loading = false;
}


// ‚úÖ S·ª∞ KI·ªÜN L∆Ø·ªöT T·ªöI CU·ªêI TRANG
window.addEventListener("scroll", () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
        loadFeed();
    }
});

function toggleLike(postId) {
    fetch(`/toggle-like/${postId}`, {
        method: "POST"
    })
    .then(res => {
        if (res.status === 401) {
            alert("B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ like!");
            return;
        }
        return res.json();
    })
    .then(data => {
        if (!data) return;

        const icon = document.getElementById(`like-icon-${postId}`);
        const count = document.getElementById(`like-count-${postId}`);

        if (data.status === "liked") {
            icon.className = "fas fa-thumbs-up text-primary";
        } else {
            icon.className = "far fa-thumbs-up";
        }

        count.innerText = data.total_likes;
    });
}

// T√≠nh nƒÉng comment
function loadComments(postId) {
    fetch(`/comment/list/${postId}`)
        .then(res => res.json())
        .then(data => {
            const box = document.getElementById(`comment-list-${postId}`);
            if (!box) return;

            box.innerHTML = "";

            data.forEach(cmt => {
                const isOwner = cmt.user_id == CURRENT_USER_ID;

                const wrapper = document.createElement("div");
                wrapper.className = "d-flex gap-2 mt-2";
                wrapper.id = `comment-${cmt.id}`;

                const img = document.createElement("img");
                img.src = `/static/${cmt.avatar}`;
                img.width = 32;
                img.style.height = "32px"; 
                img.style.objectFit = "cover";
                img.className = "rounded-circle";

                const contentBox = document.createElement("div");

                const username = document.createElement("b");
                username.innerText = cmt.username;

                const content = document.createElement("div");
                content.innerText = cmt.content;

                contentBox.appendChild(username);
                contentBox.appendChild(content);

                if (isOwner) {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-sm btn-danger mt-1";
                    btn.innerText = "X√≥a";
                    btn.onclick = () => deleteComment(cmt.id, postId);
                    contentBox.appendChild(btn);
                }

                wrapper.appendChild(img);
                wrapper.appendChild(contentBox);
                box.appendChild(wrapper);
            });
        });
}

function addComment(e, postId) {
    e.preventDefault();

    const form = e.target;
    const input = form.querySelector("input");
    const content = input.value.trim();

    if (!content) return;

    fetch(`/comment/add/${postId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `content=${encodeURIComponent(content)}`
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n!");
            return;
        }

        // ‚úÖ TH√äM COMMENT V√ÄO DOM (KH√îNG C·∫¶N LOAD L·∫†I T·∫§T C·∫¢)
        const cmt = data.comment;
        const list = document.getElementById(`comment-list-${postId}`);
        if (!list) return;

        const wrapper = document.createElement("div");
        wrapper.className = "d-flex gap-2 mt-2";
        wrapper.id = `comment-${cmt.id}`;

        const img = document.createElement("img");
        img.src = `/static/${cmt.avatar}`;
        img.width = 32;
        img.style.height = "32px"; 
        img.style.objectFit = "cover";
        img.className = "rounded-circle";

        const contentBox = document.createElement("div");

        const username = document.createElement("b");
        username.innerText = cmt.username;

        const text = document.createElement("div");
        text.innerText = cmt.content;

        contentBox.appendChild(username);
        contentBox.appendChild(text);

        // ‚úÖ DO COMMENT V·ª™A TH√äM N√äN CH·∫ÆC CH·∫ÆN L√Ä C·ª¶A USER HI·ªÜN T·∫†I
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-danger mt-1";
        btn.innerText = "X√≥a";
        btn.onclick = () => deleteComment(cmt.id, postId);
        contentBox.appendChild(btn);

        wrapper.appendChild(img);
        wrapper.appendChild(contentBox);

        // ‚úÖ TH√äM L√äN ƒê·∫¶U DANH S√ÅCH
        list.prepend(wrapper);

        // ‚úÖ TƒÇNG COMMENT COUNT
        const countBox = document.getElementById(`comment-count-${postId}`);
        if (countBox) {
            countBox.innerText = parseInt(countBox.innerText) + 1;
        }

        // ‚úÖ CLEAR INPUT
        input.value = "";
    })
    .catch(err => {
        console.error("Add comment error:", err);
    });
}

function deleteComment(commentId, postId) {
    if (!confirm("X√≥a b√¨nh lu·∫≠n n√†y?")) return;

    fetch(`/comment/delete/${commentId}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Kh√¥ng th·ªÉ x√≥a!");
            return;
        }

        // ‚úÖ X√ìA TR√äN DOM
        const el = document.getElementById(`comment-${commentId}`);
        if (el) el.remove();

        // ‚úÖ GI·∫¢M COMMENT COUNT
        const countBox = document.getElementById(`comment-count-${postId}`);
        if (countBox) {
            countBox.innerText = parseInt(countBox.innerText) - 1;
        }
    });
}

const commentLoaded = {}; // l∆∞u tr·∫°ng th√°i ƒë√£ load hay ch∆∞a

function toggleComments(postId) {
    const sectionBox = document.getElementById(`comment-section-${postId}`); // Thay ƒë·ªïi: L·∫•y container chung
    if (!sectionBox) return;

    // ‚úÖ N·∫øu ƒëang m·ªü ‚Üí ƒë√≥ng
    if (sectionBox.style.display === "block") {
        sectionBox.style.display = "none";
        return;
    }

    // ‚úÖ N·∫øu ch∆∞a load ‚Üí load l·∫ßn ƒë·∫ßu
    if (!commentLoaded[postId]) {
        loadComments(postId);
        commentLoaded[postId] = true;
    }

    sectionBox.style.display = "block";
}

// ‚úÖ H√ÄM K√çCH HO·∫†T T√åM KI·∫æM (ƒê√£ s·ª≠a l·ªói reset)
function handleSearch(event) {
    if (event) event.preventDefault(); // NgƒÉn h√†nh vi submit m·∫∑c ƒë·ªãnh
    
    const input = document.getElementById('searchInput');
    const newSearchTerm = input ? input.value.trim() : ""; 

    if (newSearchTerm === currentSearchTerm) return;
    
    currentSearchTerm = newSearchTerm;
    
    // Reset feed
    document.getElementById('feedContainer').innerHTML = '';
    page = 1; 
    done = false; 
    loading = false; // ‚úÖ QUAN TR·ªåNG: ƒê·∫£m b·∫£o loading ƒë∆∞·ª£c reset v·ªÅ false
    
    loadFeed();
}

// ‚úÖ H√ÄM X√ìA T√åM KI·∫æM
function clearSearch() {
    const input = document.getElementById('searchInput');
    if (input) input.value = '';
    handleSearch(null); // G·ªçi handleSearch v·ªõi gi√° tr·ªã r·ªóng (ƒë·ªÉ k√≠ch ho·∫°t loadFeed m·∫∑c ƒë·ªãnh)
}

// ‚úÖ FIX: K√≠ch ho·∫°t t·∫£i b√†i vi·∫øt m·∫∑c ƒë·ªãnh khi trang t·∫£i xong
window.addEventListener('load', () => {
    // L·∫•y gi√° tr·ªã t√¨m ki·∫øm ban ƒë·∫ßu t·ª´ input (ƒë·ªÉ h·ªó tr·ª£ load l·∫°i t·ª´ URL)
    const input = document.getElementById('searchInput');
    if (input) {
        currentSearchTerm = input.value.trim();
    }
    loadFeed();
});

// Gi·ªØ l·∫°i logic cu·ªôn trang (Infinite Scroll)
window.onscroll = function() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
        loadFeed();
    }
};


// ‚úÖ LOAD 10 B√ÄI ƒê·∫¶U TI√äN
document.addEventListener("DOMContentLoaded", () => {
    loadFeed();
});
</script>

{% endblock %}