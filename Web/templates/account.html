{% extends "base.html" %}

{% block title %}{{ t.profile_title }} - {{ username }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">

<div class="container my-5">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="profile-card text-center mb-4 sticky-top" style="top: 90px; z-index: 1;">
                <div class="profile-cover"></div>
                <div class="d-flex justify-content-center">
                    <div class="profile-avatar">
                        {{ username[0] | upper }}
                    </div>
                </div>
                <div class="card-body p-4">
                    <h3 class="fw-bold mb-1">{{ username }}</h3>
                    <p class="text-muted small mb-4">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ t.profile_member }}
                    </p>                    
                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="stats-box">
                                <div class="stats-num">{{ posts|length }}</div>
                                <div class="stats-label">{{ t.profile_posts }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box">
                                <div class="stats-num">{{ favorites|length }}</div>
                                <div class="stats-label">{{ t.profile_fav }}</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-dark w-100 py-2 fw-bold rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#createPostModal">
                        <i class="fas fa-pen-nib me-2"></i> {{ t.profile_write }}
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-posts-tab" data-bs-toggle="pill" data-bs-target="#pills-posts" type="button">
                        <i class="fas fa-utensils me-2"></i>{{ t.profile_my_posts }}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-fav-tab" data-bs-toggle="pill" data-bs-target="#pills-fav" type="button">
                        <i class="fas fa-heart me-2"></i>{{ t.profile_my_fav }}
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                
                <div class="tab-pane fade show active" id="pills-posts" role="tabpanel">
                    {% if posts %}
                        <div class="row g-4">
                            {% for post in posts %}
                            <div class="col-md-6">
                                <div class="item-card">
                                    <div class="item-img-wrap">
                                        {% if post.image_filename %}
                                        <img src="{{ url_for('static', filename=post.image_filename) }}" class="item-img" alt="{{ post.food_name }}">
                                        {% else %}
                                        <img src="{{ url_for('static', filename='images/default_food.jpg') }}" class="item-img" alt="No image">
                                        {% endif %}
                                        <div class="date-badge"><i class="far fa-calendar-alt me-1"></i> {{ post.posted_at.split(' ')[0] }}</div>
                                    </div>
                                    <div class="card-body p-3">
                                        <h5 class="card-title fw-bold text-truncate">{{ post.food_name }}</h5>
                                        <p class="card-text text-muted small text-truncate-3-lines">
                                            {{ post.description }}
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center mt-2 mt-auto">
                                            <span class="badge bg-light text-dark border">{{ t.profile_rating }}</span>
                                            <small class="text-muted">{{ post.posted_at.split(' ')[1][:5] }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 bg-white rounded shadow-sm">
                            <i class="fas fa-camera fa-3x text-muted mb-3 opacity-50"></i>
                            <h5 class="text-muted">{{ t.profile_no_post }}</h5>
                            <button class="btn btn-warning btn-sm mt-2 fw-bold" data-bs-toggle="modal" data-bs-target="#createPostModal">{{ t.profile_write_now }}</button>
                        </div>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="pills-fav" role="tabpanel">
                    {% if favorites %}
                        <div class="row g-4">
                            {% for fav in favorites %}
                            <div class="col-md-6" id="fav-card-{{ fav.place_id }}">
                                <div class="item-card">
                                    <div class="item-img-wrap">
                                        <img src="{{ url_for('static', filename='images/restaurant_placeholder.jpg') }}" 
                                             onerror="this.src='https://via.placeholder.com/400x250?text=Restaurant'" 
                                             class="item-img" alt="{{ fav.place_name }}">
                                        <div class="position-absolute top-0 end-0 p-2">
                                            <button class="btn btn-light btn-sm rounded-circle shadow-sm text-danger remove-fav-direct" 
                                                    data-place-id="{{ fav.place_id }}" title="Bỏ lưu">
                                                <i class="fas fa-heart"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-3">
                                        <h5 class="card-title fw-bold text-truncate">{{ fav.place_name }}</h5>
                                        <p class="small text-muted mb-2">
                                            <i class="fas fa-clock me-1"></i> {{ t.profile_saved }}: {{ fav.created_at }}
                                        </p>
                                        <button class="btn btn-outline-warning btn-sm w-100 fw-bold mt-auto btn-detail" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#foodModal"
                                                data-id="{{ fav.place_id }}" 
                                                data-name="{{ fav.place_name }}"
                                                data-location="{{ fav.location }}"
                                                data-image="{{ url_for('static', filename=fav.image) }}"
                                                data-rating="{{ fav.rating }}⭐"
                                                data-is-fav="true"> {{ t.profile_view_detail }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 bg-white rounded shadow-sm">
                            <i class="far fa-heart fa-3x text-muted mb-3 opacity-50"></i>
                            <h5 class="text-muted">{{ t.profile_empty_fav }}</h5>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-dark btn-sm mt-2">{{ t.profile_explore }}</a>
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="foodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="modalFoodName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <img id="modalFoodImage" src="" class="img-fluid rounded" alt="Food Image">
                    </div>
                    <div class="col-md-6">
                        <p><strong>{{ t.address }}:</strong> <span id="modalFoodLocation"></span></p>
                        <p><strong>{{ t.rating }}:</strong> <span id="modalFoodRating"></span></p>
                        <div class="mt-3">
                            <button id="btnSaveFavorite" class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-heart me-1"></i>  {{ t.profile_fav_done }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal">{{ t.close }}</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bắt sự kiện khi bấm nút "Xem chi tiết"
    const detailButtons = document.querySelectorAll('.btn-detail');
    detailButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Cập nhật nội dung Modal
            document.getElementById('modalFoodName').innerText = this.getAttribute('data-name');
            document.getElementById('modalFoodImage').src = this.getAttribute('data-image');
            document.getElementById('modalFoodLocation').innerText = this.getAttribute('data-location');
            document.getElementById('modalFoodRating').innerText = this.getAttribute('data-rating');
            
            // Vì đang ở trang Yêu thích, nút trong modal luôn là "Đã thích"
            const btnSave = document.getElementById('btnSaveFavorite');
            if(btnSave) {
                btnSave.innerHTML = '<i class="fas fa-heart me-1"></i> Đã thích';
                btnSave.className = "btn btn-danger btn-sm";
                btnSave.disabled = true;
            }
        });
    });
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}