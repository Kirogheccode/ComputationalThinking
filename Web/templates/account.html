{% extends "base.html" %}

{% block title %}Trang cá nhân{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">

<div class="container mt-0 mb-5">
    <div class="profile-header text-center mb-5">
        <div class="avatar-placeholder mb-3">
            {{ username[0] | upper }}
        </div>
        <h2 class="fw-bold mb-1">{{ username }}</h2>
        <p class="text-secondary small">Nhật ký ẩm thực cá nhân</p>
    </div>

    <div class="row g-4 justify-content-center">
        <div class="col-lg-4">
            <div class="flat-card p-4 sticky-top" style="top: 20px; z-index: 1;">
                <h5 class="fw-bold mb-3">Tạo bài viết mới</h5>
                <form method="POST" action="{{ url_for('your_account') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="text" class="form-control flat-input" id="food_name" name="food_name" placeholder="Tên món ăn / Địa điểm..." required>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control flat-input" id="description" name="description" rows="4" placeholder="Hương vị thế nào?..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label small text-uppercase fw-bold text-muted">Hình ảnh</label>
                        <input class="form-control flat-input" type="file" id="image" name="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-dark w-100 fw-bold py-2">ĐĂNG BÀI</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Bài viết của bạn</h4>
                <span class="badge bg-light text-dark border">{{ posts|length }} bài viết</span>
            </div>

            {% if posts %}
                <div class="row g-4">
                    {% for post in posts %}
                    <div class="col-md-6">
                        <div class="flat-card h-100 post-card" data-place-id="{{ post.food_name }}">
                            <div class="card-img-wrapper">
                                {% if post.image_filename %}
                                <img src="{{ url_for('static', filename=post.image_filename) }}" class="card-img-top post-img" alt="{{ post.food_name }}">
                                {% else %}
                                <img src="{{ url_for('static', filename='images/default_food.jpg') }}" class="card-img-top post-img" alt="No image">
                                {% endif %}
                                <div class="card-date-overlay">
                                    {{ post.posted_at.split(' ')[0] }}
                                </div>
                            </div>
                            
                            <div class="card-body p-3">
                                <h5 class="card-title fw-bold">{{ post.food_name }}</h5>
                                <p class="card-text text-secondary description-text">{{ post.description }}</p>

                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    {% set is_fav = false %}
                                    {% for fav in favorites %}
                                        {% if fav['place_id'] == post.food_name %}
                                            {% set is_fav = true %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if is_fav %}
                                    <button class="btn btn-sm btn-danger unfavorite-btn fw-bold px-3">
                                        <i class="fas fa-heart"></i> Đã thích
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-dark favorite-btn fw-bold px-3">
                                        <i class="far fa-heart"></i> Yêu thích
                                    </button>
                                    {% endif %}
                                    
                                    <small class="text-muted" style="font-size: 0.75rem;">
                                        {{ post.posted_at.split(' ')[1][:5] }} </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5 border rounded bg-light">
                    <p class="text-muted mb-0">Chưa có bài viết nào. Hãy chia sẻ món ngon đầu tiên!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const container = document.querySelector(".row");
    container.addEventListener("click", function(e) {
        const btn = e.target.closest(".favorite-btn, .unfavorite-btn");
        if (!btn) return;

        const card = btn.closest(".post-card");
        const placeId = card.dataset.placeId;
        const placeName = card.querySelector(".card-title").innerText;

        if (btn.classList.contains("favorite-btn")) {
            fetch("/favorite/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ place_id: placeId, place_name: placeName })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === "success"){
                    btn.innerHTML = '<i class="fas fa-heart"></i> Đã thích';
                    btn.classList.remove("favorite-btn", "btn-outline-dark");
                    btn.classList.add("unfavorite-btn", "btn-danger");
                }
            });
        } else if (btn.classList.contains("unfavorite-btn")) {
            fetch("/favorite/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ place_id: placeId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === "success"){
                    btn.innerHTML = '<i class="far fa-heart"></i> Yêu thích';
                    btn.classList.remove("unfavorite-btn", "btn-danger");
                    btn.classList.add("favorite-btn", "btn-outline-dark");
                }
            });
        }
    });
});
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}