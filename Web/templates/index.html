{% extends "base.html" %}

{% block title %}Trang ch·ªß - G·ª£i √Ω m√≥n ƒÉn{% endblock %}

{% block content %}
<section class="hero d-flex align-items-center justify-content-center text-center">
  <div class="container">
    <div class="hero-inner" data-aos="fade-up">
      <h1 class="display-5 hero-title">Kh√°m ph√° tinh hoa ·∫©m th·ª±c<br class="d-none d-md-block"> TP.HCM</h1>
      <p class="lead hero-sub">G·ª£i √Ω qu√°n ngon, ƒë·ªãa ƒëi·ªÉm n·ªïi b·∫≠t v√† tr·∫£i nghi·ªám ·∫©m th·ª±c kh√¥ng th·ªÉ b·ªè l·ª°.</p>
      <div class="mt-4">
        <a href="#featured" class="btn btn-warning btn-lg me-2 hero-cta">B·∫Øt ƒë·∫ßu h√†nh tr√¨nh üçú</a>
        <a href="{{ url_for('map_page') }}" class="btn btn-outline-light btn-lg">Xem tr√™n b·∫£n ƒë·ªì</a>
      </div>
    </div>
  </div>
</section>

<section class="py-4 filter-bar" id="filterBar">
  <div class="container d-flex flex-column flex-md-row align-items-center gap-3">
    <div class="d-flex align-items-center gap-2 w-100 w-md-auto">
      <select id="areaSelect" class="form-select form-select-sm">
        <option value="all" {% if area_selected == 'all' %}selected{% endif %}>T·∫•t c·∫£ khu v·ª±c</option>
        <option value="Qu·∫≠n 1" {% if area_selected == 'Qu·∫≠n 1' %}selected{% endif %}>Qu·∫≠n 1</option>
        <option value="Qu·∫≠n 3" {% if area_selected == 'Qu·∫≠n 3' %}selected{% endif %}>Qu·∫≠n 3</option>
        <option value="Qu·∫≠n 4" {% if area_selected == 'Qu·∫≠n 4' %}selected{% endif %}>Qu·∫≠n 4</option>
        <option value="Qu·∫≠n 5" {% if area_selected == 'Qu·∫≠n 5' %}selected{% endif %}>Qu·∫≠n 5</option>
        <option value="Qu·∫≠n 6" {% if area_selected == 'Qu·∫≠n 6' %}selected{% endif %}>Qu·∫≠n 6</option>
        <option value="Qu·∫≠n 7" {% if area_selected == 'Qu·∫≠n 7' %}selected{% endif %}>Qu·∫≠n 7</option>
        <option value="Qu·∫≠n 8" {% if area_selected == 'Qu·∫≠n 8' %}selected{% endif %}>Qu·∫≠n 8</option>
        <option value="Qu·∫≠n 10" {% if area_selected == 'Qu·∫≠n 10' %}selected{% endif %}>Qu·∫≠n 10</option>
        <option value="Qu·∫≠n 11" {% if area_selected == 'Qu·∫≠n 11' %}selected{% endif %}>Qu·∫≠n 11</option>
        <option value="Qu·∫≠n 12" {% if area_selected == 'Qu·∫≠n 12' %}selected{% endif %}>Qu·∫≠n 12</option>
        <option value="B√¨nh T√¢n" {% if area_selected == 'B√¨nh T√¢n' %}selected{% endif %}>B√¨nh T√¢n</option>
        <option value="B√¨nh Th·∫°nh" {% if area_selected == 'B√¨nh Th·∫°nh' %}selected{% endif %}>B√¨nh Th·∫°nh</option>
        <option value="G√≤ V·∫•p" {% if area_selected == 'G√≤ V·∫•p' %}selected{% endif %}>G√≤ V·∫•p</option>
        <option value="Ph√∫ Nhu·∫≠n" {% if area_selected == 'Ph√∫ Nhu·∫≠n' %}selected{% endif %}>Ph√∫ Nhu·∫≠n</option>
        <option value="T√¢n B√¨nh" {% if area_selected == 'T√¢n B√¨nh' %}selected{% endif %}>T√¢n B√¨nh</option>
        <option value="T√¢n Ph√∫" {% if area_selected == 'T√¢n Ph√∫' %}selected{% endif %}>T√¢n Ph√∫</option>
        <option value="Th·ªß ƒê·ª©c" {% if area_selected == 'Th·ªß ƒê·ª©c' %}selected{% endif %}>Th·ªß ƒê·ª©c</option>
      </select>
    </div>
    <div class="flex-fill">
      <input id="searchInput" class="form-control form-control-sm" type="text"
             placeholder="T√¨m m√≥n ho·∫∑c t√™n qu√°n..."
             value="{{ search_query }}">
    </div>
    <div>
      <button id="clearFilters" class="btn btn-sm btn-outline-light">X√≥a</button>
    </div>
  </div>
</section>

<section class="py-5" id="featured">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">M√≥n ƒÉn n·ªïi b·∫≠t</h2>
      <small class="text-muted">G·ª£i √Ω cho b·∫°n</small>
    </div>

    <div class="row" id="foodsGrid">
          {% for food in foods %}
          {% set is_fav = (food.id | string) in favorite_ids %}
          
          <div class="col-lg-4 col-md-6 mb-4 food-item" 
              data-area="{{ food.location }}" 
              data-name="{{ food.name | lower }}">
            
            <div class="card h-100 food-card shadow-sm"
                data-bs-toggle="modal" 
                data-bs-target="#foodModal"
                data-id="{{ food.id }}" 
                data-name="{{ food.name }}"
                data-location="{{ food.location }}"
                data-price="{{ food.price }}"
                data-hours="{{ food.hours }}"
                data-image="{{ url_for('static', filename=food.image) }}"
                data-rating="{{ food.rating }}‚≠ê"
                data-is-fav="{{ 'true' if is_fav else 'false' }}"
                data-aos="fade-up"
                data-aos-duration="800"
                data-aos-delay="{{ (loop.index0 % 3) * 150 }}">
                <div class="card-img-wrap">
                <img loading="lazy" src="{{ url_for('static', filename=food.image) }}" class="card-img-top img-hover-zoom" alt="{{ food.name }}">
                <div class="card-overlay">
                  <div class="overlay-text">
                    <h5 class="mb-0">{{ food.name }}</h5>
                  </div>
                </div>
              </div>
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-truncate fw-bold">{{ food.name }}</h5>
                <p class="card-text mb-1 text-truncate text-muted small"><i class="fas fa-map-marker-alt me-1 text-danger"></i> {{ food.location }}</p>
                
                <div class="d-flex justify-content-between align-items-center mt-auto pt-3">
                    <span class="badge bg-warning text-dark rounded-pill px-3"><i class="fas fa-star me-1"></i> {{ food.rating }}</span>
                    {% if is_fav %}
                        <span class="text-danger" title="ƒê√£ y√™u th√≠ch"><i class="fas fa-heart fa-lg animate__animated animate__heartBeat"></i></span>
                    {% endif %}
                </div>
              </div>
            </div>
          </div>
      {% endfor %}
    </div>
    </div>
  </div>
</section>

<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link" href="?page={{ page - 1 }}&area={{ area_selected }}&q={{ search_query }}">¬´ Tr∆∞·ªõc</a>
    </li>
    {% if page > 3 %}
      <li class="page-item"><a class="page-link" href="?page=1&area={{ area_selected }}&q={{ search_query }}">1</a></li>
      {% if page > 4 %}<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>{% endif %}
    {% endif %}
    {% for p in range(page-2, page+3) %}
      {% if p >= 1 and p <= total_pages %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}&area={{ area_selected }}&q={{ search_query }}">{{ p }}</a>
        </li>
      {% endif %}
    {% endfor %}
    {% if page < total_pages - 2 %}
      {% if page < total_pages - 3 %}<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>{% endif %}
      <li class="page-item"><a class="page-link" href="?page={{ total_pages }}&area={{ area_selected }}&q={{ search_query }}">{{ total_pages }}</a></li>
    {% endif %}
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="?page={{ page + 1 }}&area={{ area_selected }}&q={{ search_query }}">Sau ¬ª</a>
    </li>
  </ul>
</nav>

<div class="modal fade" id="foodModal" tabindex="-1" aria-labelledby="foodModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="modalFoodName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <img id="modalFoodImage" src="" class="img-fluid rounded shadow-sm w-100" style="object-fit: cover; height: 300px;" alt="Food Image">
                    </div>
                    <div class="col-md-6 d-flex flex-column justify-content-center">
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>ƒê·ªãa ch·ªâ:</strong> <span id="modalFoodLocation"></span></p>
                        <p class="mb-2"><i class="fas fa-star text-warning me-2"></i><strong>ƒê√°nh gi√°:</strong> <span id="modalFoodRating"></span></p>
                        <p class="mb-2"><i class="fas fa-tag text-success me-2"></i><strong>Gi√°:</strong> <span id="modalFoodPrice"></span></p>
                        <p class="mb-4"><i class="fas fa-clock text-primary me-2"></i><strong>Gi·ªù m·ªü c·ª≠a:</strong> <span id="modalFoodHours"></span></p>
                        
                        <div class="d-flex gap-2">
                            <button id="btnViewMap" class="btn btn-outline-primary flex-grow-1">
                                <i class="fa-solid fa-map-location-dot me-1"></i> Xem b·∫£n ƒë·ªì
                            </button>
                            
                            <button id="btnSaveFavorite" class="btn btn-warning flex-grow-1">
                                <i class="far fa-heart me-1"></i> Y√™u th√≠ch
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentFoodId = null;
    let currentFoodName = null;
    let currentCard = null; // Th·∫ª card ƒëang ƒë∆∞·ª£c click
    let currentLocation = null; // L∆∞u ƒë·ªãa ch·ªâ ƒë·ªÉ chuy·ªÉn qua map

    // 1. B·∫Øt s·ª± ki·ªán click v√†o Card (thay v√¨ n√∫t chi ti·∫øt)
    const foodCards = document.querySelectorAll('.food-card');
    
    foodCards.forEach(card => {
        card.addEventListener('click', function() {
            currentCard = this; 
            currentFoodId = this.getAttribute('data-id');
            currentFoodName = this.getAttribute('data-name');
            currentLocation = this.getAttribute('data-location');
            
            const isFav = this.getAttribute('data-is-fav') === 'true';
            
            // C·∫≠p nh·∫≠t th√¥ng tin v√†o Modal
            document.getElementById('modalFoodName').innerText = currentFoodName;
            document.getElementById('modalFoodImage').src = this.getAttribute('data-image');
            document.getElementById('modalFoodLocation').innerText = currentLocation;
            document.getElementById('modalFoodRating').innerText = this.getAttribute('data-rating');
            
            // C·∫≠p nh·∫≠t th√¥ng tin m·ªõi (Gi√° & Gi·ªù)
            document.getElementById('modalFoodPrice').innerText = this.getAttribute('data-price');
            document.getElementById('modalFoodHours').innerText = this.getAttribute('data-hours');
            
            // X·ª≠ l√Ω n√∫t Y√™u th√≠ch
            setupFavoriteButton(isFav);
        });
    });

    // 2. X·ª≠ l√Ω n√∫t "Xem b·∫£n ƒë·ªì" - Chuy·ªÉn trang k√®m tham s·ªë
    document.getElementById('btnViewMap').addEventListener('click', function() {
        if (currentLocation) {
            // Encode ƒë·ªãa ch·ªâ ƒë·ªÉ an to√†n tr√™n URL
            const encodedLocation = encodeURIComponent(currentLocation);
            window.location.href = `/map?destination=${encodedLocation}`;
        }
    });

    // 3. H√†m x·ª≠ l√Ω n√∫t Y√™u th√≠ch (T√°ch ri√™ng cho g·ªçn)
    function setupFavoriteButton(isFav) {
        const btnSave = document.getElementById('btnSaveFavorite');
        if(!btnSave) return;

        // Reset button clone ƒë·ªÉ x√≥a event listener c≈©
        const newBtn = btnSave.cloneNode(true);
        btnSave.parentNode.replaceChild(newBtn, btnSave);
        const finalBtn = document.getElementById('btnSaveFavorite');

        // Set tr·∫°ng th√°i ban ƒë·∫ßu
        updateFavoriteButtonUI(finalBtn, isFav);

        // G√°n s·ª± ki·ªán click
        finalBtn.addEventListener('click', function() {
            handleToggleFavorite(finalBtn);
        });
    }

    function updateFavoriteButtonUI(btn, isFav) {
        if (isFav) {
            btn.innerHTML = '<i class="fas fa-heart me-1"></i> ƒê√£ th√≠ch';
            btn.className = "btn btn-danger flex-grow-1"; 
        } else {
            btn.innerHTML = '<i class="far fa-heart me-1"></i> Y√™u th√≠ch';
            btn.className = "btn btn-warning flex-grow-1";
        }
    }

    function handleToggleFavorite(btn) {
        if(!currentFoodId) return;
        const isCurrentlyFav = currentCard.getAttribute('data-is-fav') === 'true';

        if (isCurrentlyFav) {
            // Remove logic
            fetch('/favorite/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ place_id: currentFoodId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    updateFavoriteButtonUI(btn, false);
                    currentCard.setAttribute('data-is-fav', 'false');
                }
            });
        } else {
            // Add logic
            fetch('/favorite/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    place_id: currentFoodId,
                    place_name: currentFoodName
                })
            })
            .then(response => {
                if(response.status === 401) {
                    window.location.href = "/login";
                    return;
                }
                return response.json();
            })
            .then(data => {
                if(data && data.status === 'success') {
                    updateFavoriteButtonUI(btn, true);
                    currentCard.setAttribute('data-is-fav', 'true');
                }
            });
        }
    }
});
</script>
{% endblock %}