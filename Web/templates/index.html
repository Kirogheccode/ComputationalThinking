{% extends "base.html" %}

{% block title %}{{ lang.home }} - Smart Tourism{% endblock %}

{% block content %}

<div class="container mt-4">
    <h3 class="fw-bold mb-4">{{lang.your_feed}}</h3>

    <div id="feedContainer"></div>

    <p id="endMessage" class="text-center text-muted mt-4" style="display:none">
        {{lang.end_view}}.
    </p>

    <div id="loading" class="text-center mt-4 text-muted" style="display:none">
        {{lang.loading_posts}}...
    </div>
</div>

<script>
let page = 1;         
let loading = false; 
let done = false;    

const MAX_DOM_POSTS = 40; // ✅ Giữ tối đa 40 bài trên màn hình

async function loadFeed() {
    if (loading || done) return;

    loading = true;
    document.getElementById("loading").style.display = "block";

    const res = await fetch(`/api/feed?page=${page}`);
    const posts = await res.json();

    document.getElementById("loading").style.display = "none";

    // ✅ HẾT BÀI
    if (posts.length === 0) {
        done = true;
        document.getElementById("endMessage").style.display = "block";
        return;
    }

    const feedContainer = document.getElementById("feedContainer");

    posts.forEach(post => {
        const rating = post.rating || 5;

        let stars = "";
        for (let i = 1; i <= 5; i++) {
            stars += i <= rating 
                ? `<i class="fas fa-star text-warning"></i>` 
                : `<i class="far fa-star text-muted"></i>`;
        }

        feedContainer.innerHTML += `
            <div class="card mb-4 shadow-sm feed-item">

                <!-- ✅ HEADER -->
                <div class="card-header border-0 d-flex align-items-center gap-2 mt-3">
                    <img src="/static/${post.avatar || '/static/images/default-avatar.jpg'}" 
                         class="rounded-circle"
                         width="60" height="60"
                         onerror="this.src='/static/images/default-avatar.jpg'">

                    <div>
                        <div class="fw-bold">@${post.username}</div>
                        <div class="small text-muted">${post.posted_at}</div>
                    </div>
                </div>

                <!-- ✅ BODY -->
                <div class="card-body pt-2">
                    <h6 class="fw-bold mb-1">${post.food_name}</h6>

                    <!-- ⭐ RATING -->
                    <div class="mb-2">${stars}</div>

                    <p class="mb-3">${post.description}</p>

                    ${
                        post.image_filename 
                        ? `<img src="/static/${post.image_filename}" class="img-fluid rounded mb-3">` 
                        : ""
                    }

                    <!-- ✅ LIKE + COMMENT BAR (CHƯA CÓ LOGIC) -->
                    <div class="d-flex justify-content-around border-top pt-2 text-muted">
                        <div><i class="far fa-thumbs-up"></i> Like</div>
                        <div><i class="far fa-comment"></i> Comment</div>
                    </div>
                </div>
            </div>
        `;
    });

    // ✅ TỰ ĐỘNG XÓA BÀI CŨ NẾU QUÁ 40 BÀI
    const items = document.querySelectorAll(".feed-item");
    if (items.length > MAX_DOM_POSTS) {
        const excess = items.length - MAX_DOM_POSTS;
        for (let i = 0; i < excess; i++) {
            items[i].remove(); 
        }
    }

    page++;       
    loading = false;
}


// ✅ SỰ KIỆN LƯỚT TỚI CUỐI TRANG
window.addEventListener("scroll", () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
        loadFeed();
    }
});


// ✅ LOAD 10 BÀI ĐẦU TIÊN
loadFeed();
</script>

{% endblock %}